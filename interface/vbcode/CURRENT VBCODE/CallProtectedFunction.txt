' version 0.7.14.21
' Function to call a protected PostgreSQL function


Public Function CallProtectedFunction(functionName As String, requiredRoleId As Long, ParamArray args()) As Variant
    If Not ValidateSessionAndPermission(requiredRoleId) Then
        MsgBox "Invalid session or insufficient permissions", vbExclamation
        Exit Function
    End If
    
    Dim cmd As ADODB.Command
    Dim rs As ADODB.Recordset
    Dim i As Long
    
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = g_conn
        .CommandText = "SELECT * FROM " & functionName & "(?"
        
        ' Add session_id parameter
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        
        ' Add other parameters
        For i = 0 To UBound(args)
            .CommandText = .CommandText & ", ?"
            .Parameters.Append .CreateParameter("@p" & i, adVariant, adParamInput, , args(i))
        Next i
        
        .CommandText = .CommandText & ")"
    End With
    
    Set rs = cmd.Execute
    
    ' Return the result (adjust as needed based on your function's return type)
    If Not rs.EOF Then
        CallProtectedFunction = rs.Fields(0).Value
    End If
    
    rs.Close
    Set rs = Nothing
    Set cmd = Nothing
End Function

