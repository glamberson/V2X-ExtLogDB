' global variables
' version 0.7.14.21
Option Compare Database
Option Explicit

' Declare a global variable to store the session token
Public g_sessionToken As String
Public g_conn As ADODB.Connection
Public g_connString As String
Public g_userId As Long
Public g_roleId As Long

' Initialize Postgres Connection
' version 0.7.14.4

Public Sub InitializePostgresConnection()
    If g_conn Is Nothing Then
        g_connString = "Driver={PostgreSQL Unicode};" & _
                       "Server=localhost;" & _
                       "Port=5432;" & _
                       "Database=Beta_003;" & _
                       "Uid=login;" & _
                       "Pwd=FOTS-Egypt;"
        Set g_conn = New ADODB.Connection
        g_conn.ConnectionString = g_connString
        g_conn.Open
    End If
End Sub


' CreatePostgresConnection
' version 0.7.14.4


Public Function CreatePostgresConnection() As ADODB.Connection
    ' Just return the existing connection as it's supposed to be initialized only once
    Set CreatePostgresConnection = g_conn
End Function


' ValidateUser
' Version 0.8.02

Public Function ValidateUser(username As String, password As String) As Boolean
    Dim cmd As ADODB.Command
    Dim rs As ADODB.Recordset
    Dim isValid As Boolean
    Dim dbRoleName As String

    If g_conn Is Nothing Then
        InitializePostgresConnection
    End If

    Set cmd = New ADODB.Command
    cmd.ActiveConnection = g_conn
    cmd.commandText = "SELECT * FROM login_wrapper(?, ?, ?)"
    cmd.Parameters.Append cmd.CreateParameter("@p_username", adVarChar, adParamInput, 255, username)
    cmd.Parameters.Append cmd.CreateParameter("@p_password", adVarChar, adParamInput, 255, password)
    cmd.Parameters.Append cmd.CreateParameter("@p_duration", adVarChar, adParamInput, 255, "1 hour")

    Set rs = cmd.Execute
    If Not rs.EOF Then
        ' Check if session_id is NULL, which indicates a failed login attempt
        If Not IsNull(rs.Fields("session_id").Value) Then
            g_sessionToken = rs.Fields("session_id").Value
            g_userId = rs.Fields("login_user_id").Value
            g_roleId = rs.Fields("login_role_id").Value
            dbRoleName = rs.Fields("login_db_role_name").Value
            isValid = True
            
            ' Set the user role
            Set cmd = New ADODB.Command
            cmd.ActiveConnection = g_conn
            cmd.commandText = "SELECT set_user_role(?)"
            cmd.Parameters.Append cmd.CreateParameter("@p_db_role_name", adVarChar, adParamInput, 255, dbRoleName)
            cmd.Execute
        Else
            ' Handle the failed login case
            isValid = False
            MsgBox "Invalid username or password.", vbExclamation
        End If
    Else
        isValid = False
        MsgBox "Invalid username or password.", vbExclamation
    End If

    rs.Close

    ValidateUser = isValid
End Function

