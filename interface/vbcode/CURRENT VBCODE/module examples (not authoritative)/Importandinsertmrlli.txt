
' import and insert mrl line items
' 0.7.12
Sub ImportAndInsertMRLLineItems()
    If Not ValidateExcelData() Then
        MsgBox "Data validation failed. Please correct the errors and try again."
        Exit Sub
    End If
    
    ImportExcelToAccess
    InsertMRLLineItems
    
End Sub

' import excel to access
' version 0.8.32
Sub ImportExcelToAccess()
    Dim originalFilePath As String
    Dim tempFilePath As String
    Dim xlApp As Object
    Dim xlWorkbook As Object
    Dim xlSheet As Object
    Dim col As Integer
    Dim db As DAO.Database
    
    originalFilePath = "C:\Beta_003\MRL.xlsx"
    tempFilePath = "C:\Beta_003\TempMRL.xlsx"
    
    ' Delete TempTable if it exists
    Set db = CurrentDb()
    On Error Resume Next
    db.Execute "DROP TABLE TempTable"
    On Error GoTo 0
    
    ' Create a copy of the original file
    FileCopy originalFilePath, tempFilePath
    
    ' Create a new Excel application instance
    Set xlApp = CreateObject("Excel.Application")
    ' Open the temp workbook
    Set xlWorkbook = xlApp.Workbooks.Open(tempFilePath)
    ' Set the worksheet
    Set xlSheet = xlWorkbook.Sheets("Sheet1") ' Adjust to your sheet name
    
    ' Clean up field names in the first row
    For col = 1 To xlSheet.UsedRange.Columns.count
        xlSheet.Cells(1, col).Value = Trim(xlSheet.Cells(1, col).Value)
    Next col
    
    ' Save and close the workbook
    xlWorkbook.Save
    xlWorkbook.Close False
    ' Quit Excel application
    xlApp.Quit
    
    ' Clean up
    Set xlSheet = Nothing
    Set xlWorkbook = Nothing
    Set xlApp = Nothing

    ' Import the cleaned Excel file into Access
    DoCmd.TransferSpreadsheet acImport, acSpreadsheetTypeExcel12, "TempTable", tempFilePath, True
    
    ' Delete the temporary file
    Kill tempFilePath
    
    Set db = Nothing
End Sub

'Convert to JSON
'version 0.8.15
Public Function ConvertToJSON() As Variant
    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim json As String
    Dim f As DAO.Field
    Dim keyFields As Collection
    Dim keyField As Variant
    Dim isEmptyRecord As Boolean
    Dim trimmedFieldName As String
    Dim errorLog As String
    Dim recordCount As Long
    Dim errorCount As Long
    
    ' Define the key fields to check
    Set keyFields = New Collection
    keyFields.Add "jcn"
    keyFields.Add "twcode"
    keyFields.Add "qty"
    keyFields.Add "request_date"
    ' Add other key fields as needed

    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM TempTable")

    If rs.EOF Then
        ConvertToJSON = Array("[]", "No records found.")
        Exit Function
    End If

    json = "["
    errorLog = ""
    recordCount = 0
    errorCount = 0
    
    Do While Not rs.EOF
        recordCount = recordCount + 1
        isEmptyRecord = True
        
        ' Check if key fields are empty
        For Each keyField In keyFields
            On Error Resume Next
            trimmedFieldName = Trim(keyField)
            If IsNull(rs.Fields(trimmedFieldName)) Or rs.Fields(trimmedFieldName).Value = "" Then
                If Err.Number = 0 Then
                    errorLog = errorLog & "Record " & recordCount & ": Empty " & trimmedFieldName & vbCrLf
                Else
                    errorLog = errorLog & "Record " & recordCount & ": Missing field " & trimmedFieldName & vbCrLf
                End If
                errorCount = errorCount + 1
            Else
                isEmptyRecord = False
            End If
            On Error GoTo 0
        Next keyField
        
        If Not isEmptyRecord Then
            json = json & "{"
            For Each f In rs.Fields
                trimmedFieldName = Trim(f.Name)
                json = json & """" & trimmedFieldName & """:"
                On Error Resume Next
                If IsNull(f.Value) Then
                    json = json & "null"
                ElseIf f.Type = dbText Then
                    json = json & """" & Replace(Replace(f.Value, "\", "\\"), """", "\""") & """"
                ElseIf f.Type = dbDate Then
                    json = json & """" & Format(f.Value, "yyyy-mm-ddThh:nn:ss") & """"
                Else
                    json = json & f.Value
                End If
                If Err.Number <> 0 Then
                    errorLog = errorLog & "Record " & recordCount & ": Error in field " & trimmedFieldName & " - " & Err.Description & vbCrLf
                    errorCount = errorCount + 1
                    Err.Clear
                End If
                On Error GoTo 0
                json = json & ","
            Next f
            json = Left(json, Len(json) - 1) ' Remove trailing comma
            json = json & "},"
        End If

        rs.MoveNext
    Loop
    
    If Right(json, 1) = "," Then
        json = Left(json, Len(json) - 1) ' Remove trailing comma from the last record
    End If
    
    json = json & "]"
    
    rs.Close
    Set rs = Nothing
    Set db = Nothing
    
    errorLog = "Total Records: " & recordCount & vbCrLf & _
               "Records with Errors: " & errorCount & vbCrLf & vbCrLf & errorLog
    
    ConvertToJSON = Array(json, errorLog)
End Function

' insert mrl line items
' version 0.8.35

Public Sub InsertMRLLineItems()
    Dim jsonData As Variant
    Dim updateSource As String
    Dim success As Boolean
    Dim errorMessage As String
    Dim jsonString As String
    Dim errorLog As String
    
    Set frm = Forms!frMRL
    jsonData = ConvertToJSON()
    jsonString = CStr(jsonData(0))
    errorLog = CStr(jsonData(1))
    updateSource = frm.txtUpdateSource.Value ' Get the update source from the text box
    
    ' Debugging output
    Debug.Print "Function name: insert_mrl_line_items"
    Debug.Print "JSON Data length: " & Len(jsonString)
    Debug.Print "Update Source: " & updateSource
    Debug.Print "Pre-insert Error Log: " & errorLog
    
    ' Call the protected function with correct number of parameters
    success = ExecuteProtectedFunction("insert_mrl_line_items", jsonString, updateSource)
    
    ' Check for errors returned by the procedure
    If Not success Then
        errorMessage = "Procedure execution failed. Check the database logs for details."
    End If
    
    ' Parse the results if there's an error message
    Dim totalCount As Long, successCount As Long, errorCount As Long
    If Len(errorMessage) > 0 Then
        ParseResults errorMessage, totalCount, successCount, errorCount
    Else
        ' If no error message, assume all records were processed successfully
        totalCount = GetJSONRecordCount(jsonString)
        successCount = totalCount
        errorCount = 0
    End If
    
    ' Display results
    If success And errorCount = 0 Then
        MsgBox "All records processed successfully." & vbNewLine & _
               "Total Records: " & totalCount, vbInformation
    Else
        MsgBox "Process completed with some errors." & vbNewLine & _
               "Total Records: " & totalCount & vbNewLine & _
               "Successful Inserts: " & successCount & vbNewLine & _
               "Failed Inserts: " & errorCount & vbNewLine & _
               "See error log for details.", vbExclamation
    End If
    
    ' Save error logs to a file
    Dim fso As Object
    Dim fileName As String
    Set fso = CreateObject("Scripting.FileSystemObject")
    fileName = "C:\Temp\MRLInsertErrorLog_" & Format(Now, "yyyymmdd_hhnnss") & ".txt"
    fso.CreateTextFile(fileName).Write "Pre-insert Errors:" & vbNewLine & errorLog & vbNewLine & vbNewLine & _
                                       "PostgreSQL Errors:" & vbNewLine & errorMessage
    MsgBox "Error log has been saved to " & fileName, vbInformation
End Sub


' version 0.8.34
' Helper function to get the number of records in the JSON string

Private Function GetJSONRecordCount(jsonString As String) As Long
    Dim count As Long
    Dim i As Long
    count = 0
    For i = 1 To Len(jsonString)
        If Mid(jsonString, i, 1) = "{" Then
            count = count + 1
        End If
    Next i
    GetJSONRecordCount = count
End Function

' Parse results from error message
' version 0.8.35

Private Sub ParseResults(errorMessage As String, ByRef totalCount As Long, ByRef successCount As Long, ByRef errorCount As Long)
    Dim regex As Object
    Set regex = CreateObject("VBScript.RegExp")
    regex.Pattern = "Total: (\d+), Success: (\d+), Errors: (\d+)"
    regex.Global = False
    
    Dim matches As Object
    Set matches = regex.Execute(errorMessage)
    
    If matches.count > 0 Then
        totalCount = CLng(matches(0).SubMatches(0))
        successCount = CLng(matches(0).SubMatches(1))
        errorCount = CLng(matches(0).SubMatches(2))
    Else
        totalCount = 0
        successCount = 0
        errorCount = 0
    End If
End Sub



' validate excel data
' version 0.7.12
Public Function ValidateExcelData() As Boolean
    Dim xlApp As Object
    Dim xlWorkbook As Object
    Dim xlSheet As Object
    Dim row As Integer
    Dim isValid As Boolean
    
    ' Create a new Excel application instance
    Set xlApp = CreateObject("Excel.Application")
    ' Open the workbook
    Set xlWorkbook = xlApp.Workbooks.Open("C:\Beta_003\MRL.xlsx")
    ' Set the worksheet
    Set xlSheet = xlWorkbook.Sheets("Sheet1") ' Adjust to your sheet name
    isValid = True
    
    For row = 2 To xlSheet.Cells(xlSheet.Rows.count, "A").End(-4162).row ' Assuming row 1 is the header row
        If IsEmpty(xlSheet.Cells(row, 1)) Then ' Validate jcn
            MsgBox "Error: jcn is required at row " & row
            isValid = False
        End If
        
        If Not IsNumeric(xlSheet.Cells(row, 8)) Or xlSheet.Cells(row, 8).Value <= 0 Then ' Validate qty
            MsgBox "Error: qty must be a positive number at row " & row
            isValid = False
        End If
        
        If Not IsDate(xlSheet.Cells(row, 13)) Then ' Validate request_date
            MsgBox "Error: request_date must be a valid date at row " & row
            isValid = False
        End If
        
        If Not IsNumeric(xlSheet.Cells(row, 28)) Then ' Validate created_by
            MsgBox "Error: created_by must be a number at row " & row
            isValid = False
        End If
        
        ' Additional validation rules can be added here...
        
        If Not isValid Then Exit For
    Next row
    
    ' Close the workbook without saving
    xlWorkbook.Close False
    ' Quit Excel application
    xlApp.Quit
    
    ' Clean up
    Set xlSheet = Nothing
    Set xlWorkbook = Nothing
    Set xlApp = Nothing
    
    ValidateExcelData = isValid
End Function
        
' execute postgres command
' version 0.7.14.22

Public Sub ExecutePostgresCommand(cmdText As String, ParamArray params() As Variant)
    On Error GoTo ErrorHandler
    
    Dim conn As ADODB.Connection
    Dim cmd As ADODB.Command
    Dim i As Integer

    Set conn = CreatePostgresConnection()
    Set cmd = New ADODB.Command
    cmd.ActiveConnection = conn
    cmd.commandText = cmdText

    For i = LBound(params) To UBound(params)
        cmd.Parameters.Append cmd.CreateParameter("@param" & i + 1, adVarChar, adParamInput, 255, params(i))
    Next i

    cmd.Execute
    Exit Sub

ErrorHandler:
    MsgBox "Error: " & Err.Description, vbCritical
    Exit Sub
End Sub







