Option Compare Database

'   version 0.7.14.22
' Function to check session and permission

Public Function CheckSessionAndPermission(requiredRoleId As Long) As Boolean
    Dim cmd As ADODB.Command
    Dim rs As ADODB.Recordset
    Dim isValid As Boolean
    
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = g_conn
        .commandText = "SELECT * FROM validate_session_and_permission(?, ?)"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_required_role_id", adInteger, adParamInput, , requiredRoleId)
    End With
    
    Set rs = cmd.Execute
    
    If Not rs.EOF Then
        isValid = rs.Fields("is_valid").Value
        If isValid Then
            g_userId = rs.Fields("user_id").Value
            g_roleId = rs.Fields("role_id").Value
        End If
    Else
        isValid = False
    
    rs.Close
    Set rs = Nothing
    Set cmd = Nothing
    
    CheckSessionAndPermission = isValid
End Function

' execute protected (postgres) function or procedure
' version 0.8.42

Public Function ExecuteProtectedFunction(functionName As String, ParamArray args()) As Variant
    Dim cmdValidate As ADODB.Command
    Dim cmdExecute As ADODB.Command
    Dim cmdRenew As ADODB.Command
    Dim rs As ADODB.Recordset
    Dim functionArgs() As Variant
    Dim i As Long
    Dim commandText As String
    
    ' Store args in a separate array to ensure they're not lost
    ReDim functionArgs(LBound(args) To UBound(args))
    For i = LBound(args) To UBound(args)
        functionArgs(i) = args(i)
    Next i
    
    ' Debug print arguments
    For i = LBound(functionArgs) To UBound(functionArgs)
        Debug.Print "Argument " & i & ": Type=" & TypeName(functionArgs(i)) & ", Value=" & Left$(CStr(functionArgs(i)), 100)
    Next i
    
    ' Validate session and permission
    Set cmdValidate = New ADODB.Command
    With cmdValidate
        .ActiveConnection = g_conn
        .commandText = "SELECT (validate_session_and_permission(?, ?)).*"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_function_name", adVarChar, adParamInput, 255, functionName)
    End With
    
    Set rs = cmdValidate.Execute
    
    Dim isValid As Boolean
    If Not rs.EOF Then
        isValid = rs.Fields("is_valid").Value
    Else
        isValid = False
    End If
    
    rs.Close
    Set rs = Nothing
    Set cmdValidate = Nothing
    
    If Not isValid Then
        MsgBox "You don't have permission to perform this action.", vbExclamation
        ExecuteProtectedFunction = False
        Exit Function
    End If
    
    ' Execute the actual function or procedure
    Set cmdExecute = New ADODB.Command
    With cmdExecute
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        
        If functionName = "insert_mrl_line_items" Then
            commandText = "CALL " & functionName & "("
            
            ' Add parameters
            For i = LBound(functionArgs) To UBound(functionArgs)
                If i > LBound(functionArgs) Then commandText = commandText & ", "
                If i = LBound(functionArgs) Then
                    commandText = commandText & "?::jsonb"
                ElseIf i = LBound(functionArgs) + 1 Then
                    commandText = commandText & "?::text"
                Else
                    commandText = commandText & "?"
                End If
            Next i
            
            ' Add output parameter for summary
            If UBound(functionArgs) - LBound(functionArgs) + 1 = 2 Then
                commandText = commandText & ", ?"
            End If
            
            commandText = commandText & ")"
            
            .commandText = commandText
            
            ' Add parameters
            For i = LBound(functionArgs) To UBound(functionArgs)
                .Parameters.Append .CreateParameter("param" & (i + 1), adLongVarChar, adParamInput, -1, functionArgs(i))
            Next i
            
            ' Add output parameter for summary
            If UBound(functionArgs) - LBound(functionArgs) + 1 = 2 Then
                .Parameters.Append .CreateParameter("summary", adVarChar, adParamOutput, 1000)
            End If
        Else
            ' Handle other functions/procedures as before
            commandText = "CALL " & functionName & "("
            
            ' Add parameters
            For i = LBound(functionArgs) To UBound(functionArgs)
                If i > LBound(functionArgs) Then commandText = commandText & ", "
                commandText = commandText & "?"
                .Parameters.Append .CreateParameter("param" & (i + 1), adLongVarChar, adParamInput, -1, functionArgs(i))
            Next i
            
            commandText = commandText & ")"
            .commandText = commandText
        End If
        
        ' Debug print
        Debug.Print "Command text: " & commandText
        Debug.Print "Command text length: " & Len(commandText)
    End With
    
    On Error GoTo ErrorHandler
    
    cmdExecute.Execute
    
    ' For insert_mrl_line_items, retrieve the summary from the output parameter
    If functionName = "insert_mrl_line_items" Then
        ExecuteProtectedFunction = cmdExecute.Parameters("summary").Value
    Else
        ExecuteProtectedFunction = True ' Indicate success for other procedures
    End If
    
    ' Renew session
    Set cmdRenew = New ADODB.Command
    With cmdRenew
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        .commandText = "SELECT renew_session(?, ?)"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_duration", adVarChar, adParamInput, 255, "1 hour")
    End With
    
    Set rs = cmdRenew.Execute
    
    If Not rs.EOF Then
        Dim renewSuccess As Boolean
        renewSuccess = rs.Fields(0).Value
        If Not renewSuccess Then
            Debug.Print "Failed to renew session"
        End If
    End If
    
    Exit Function

ErrorHandler:
    Debug.Print "Error in ExecuteProtectedFunction: " & Err.Description
    Debug.Print "Error Number: " & Err.Number
    Debug.Print "Command Text: " & commandText
    Debug.Print "Command Text length: " & Len(commandText)
    
    ' Print out all parameter values for debugging
    For i = LBound(functionArgs) To UBound(functionArgs)
        Debug.Print "Parameter " & i + 1 & ": Type=" & TypeName(functionArgs(i)) & ", Value=" & Left$(CStr(functionArgs(i)), 100) & "..."
    Next i
    
    ExecuteProtectedFunction = "Error: " & Err.Description ' Return error message
    If Err.Number = 42883 Then  ' Function does not exist
        MsgBox "Function or procedure '" & functionName & "' does not exist.", vbExclamation
    Else
        MsgBox "An error occurred: " & Err.Description & vbNewLine & _
               "See Immediate window for more details.", vbExclamation
    End If

CleanUp:
    ' Clean up
    If Not rs Is Nothing Then
        rs.Close
        Set rs = Nothing
    End If
    Set cmdExecute = Nothing
    Set cmdRenew = Nothing
End Function

' version 0.8.40
' Helper function to parse NOTICE message
Private Function ParseNoticeMessage(message As String) As Variant
    Dim result(3) As Long
    Dim matches As Object
    Dim regex As Object
    
    Set regex = CreateObject("VBScript.RegExp")
    regex.Pattern = "Total: (\d+), Success: (\d+), Duplicates: (\d+), Errors: (\d+)"
    regex.Global = False
    
    Set matches = regex.Execute(message)
    
    If matches.count > 0 Then
        result(0) = CLng(matches(0).SubMatches(0)) ' Total
        result(1) = CLng(matches(0).SubMatches(1)) ' Success
        result(2) = CLng(matches(0).SubMatches(2)) ' Duplicates
        result(3) = CLng(matches(0).SubMatches(3)) ' Errors
    End If
    
    ParseNoticeMessage = result
End Function

