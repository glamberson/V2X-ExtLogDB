' insert mrl line items
' version 0.8.14

Public Sub InsertMRLLineItems()
    Dim jsonData As Variant
    Dim updateSource As String
    Dim success As Boolean
    Dim errorMessage As String
    Dim jsonString As String
    Dim errorLog As String
    
    Set frm = Forms!frMRL
    jsonData = ConvertToJSON()
    jsonString = jsonData(0)
    errorLog = jsonData(1)
    updateSource = frm.txtUpdateSource.Value ' Get the update source from the text box
    
    ' Debugging output
    Debug.Print "JSON Data (first 1000 characters): " & Left(jsonString, 1000) & "..."
    Debug.Print "Update Source: " & updateSource
    Debug.Print "Pre-insert Error Log: " & errorLog
    
    ' Call the protected function
    success = ExecuteProtectedFunction("insert_mrl_line_items", jsonString, updateSource, errorMessage)
    
    ' Parse the results
    Dim totalCount As Integer, successCount As Integer, errorCount As Integer
    ParseResults errorMessage, totalCount, successCount, errorCount
    
    ' Display results
    If success Then
        MsgBox "All records processed successfully." & vbNewLine & _
               "Total Records: " & totalCount, vbInformation
    Else
        MsgBox "Process completed with some errors." & vbNewLine & _
               "Total Records: " & totalCount & vbNewLine & _
               "Successful Inserts: " & successCount & vbNewLine & _
               "Failed Inserts: " & errorCount & vbNewLine & _
               "See error log for details.", vbExclamation
    End If
    
    ' Save error logs to a file
    Dim fso As Object
    Dim fileName As String
    Set fso = CreateObject("Scripting.FileSystemObject")
    fileName = "C:\Temp\MRLInsertErrorLog_" & Format(Now, "yyyymmdd_hhnnss") & ".txt"
    fso.CreateTextFile(fileName).Write "Pre-insert Errors:" & vbNewLine & errorLog & vbNewLine & vbNewLine & _
                                       "PostgreSQL Errors:" & vbNewLine & errorMessage
    MsgBox "Error log has been saved to " & fileName, vbInformation
End Sub

