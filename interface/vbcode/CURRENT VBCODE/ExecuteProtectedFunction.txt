
' execute protected (postgres) function or procedure
' version 0.8.12

Public Function ExecuteProtectedFunction(functionName As String, ParamArray args()) As Variant
    Dim cmd As ADODB.Command
    Dim rs As ADODB.Recordset
    
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = g_conn
        .CommandText = "SELECT (validate_session_and_permission(?, ?)).*"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_function_name", adVarChar, adParamInput, 255, functionName)
    End With
    
    Set rs = cmd.Execute
    
    Dim isValid As Boolean
    If Not rs.EOF Then
        isValid = rs.Fields("is_valid").Value
    Else
        isValid = False
    End If
    
    rs.Close
    Set rs = Nothing
    
    If Not isValid Then
        MsgBox "You don't have permission to perform this action.", vbExclamation
        ExecuteProtectedFunction = False
        Exit Function
    End If
    
    ' Execute the actual function or procedure
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        .CommandText = "CALL " & functionName & "("
        
        ' Add parameters
        Dim j As Long
        For j = LBound(args) To UBound(args)
            If j > LBound(args) Then .CommandText = .CommandText & ", "
            .CommandText = .CommandText & "?"
            On Error Resume Next
            .Parameters.Append .CreateParameter("param" & (j + 1), adVarChar, adParamInput, 8000, args(j))
            If Err.Number <> 0 Then
                Dim errMsg As String
                errMsg = "Error adding parameter " & j + 1 & " to command:" & vbNewLine & _
                         "Value: " & args(j) & vbNewLine & _
                         "Error: " & Err.Description
                Debug.Print errMsg
                MsgBox errMsg, vbExclamation, "Parameter Error"
                ExecuteProtectedFunction = False
                Exit Function
            End If
            On Error GoTo 0
        Next j
        
        .CommandText = .CommandText & ")"
    End With
    
    On Error GoTo ErrorHandler
    
    cmd.Execute
    
    ' Call renew_session after successful execution
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        .CommandText = "SELECT renew_session(?, ?)"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_duration", adVarChar, adParamInput, 255, "1 hour")
    End With
    
    Set rs = cmd.Execute
    
    If Not rs.EOF Then
        Dim renewSuccess As Boolean
        renewSuccess = rs.Fields(0).Value
        If Not renewSuccess Then
            Debug.Print "Failed to renew session"
        End If
    End If
    
    rs.Close
    Set rs = Nothing
    
    ExecuteProtectedFunction = True ' Indicate success
    
    Set cmd = Nothing
    Exit Function

ErrorHandler:
    Debug.Print "Error in ExecuteProtectedFunction: " & Err.Description
    Debug.Print "Error Number: " & Err.Number
    Debug.Print "Command Text: " & cmd.CommandText
    
    ' Print out all parameter values for debugging
    For j = LBound(args) To UBound(args)
        Debug.Print "Parameter " & j + 1 & ": " & args(j)
    Next j
    
    ExecuteProtectedFunction = False ' Indicate failure
    If Err.Number = 42883 Then  ' Function does not exist
        MsgBox "Function or procedure '" & functionName & "' does not exist.", vbExclamation
    Else
        MsgBox "An error occurred: " & Err.Description & vbNewLine & _
               "See Immediate window for more details.", vbExclamation
    End If
End Function


