' execute protected (postgres) function or procedure
' version 0.8.40

Public Function ExecuteProtectedFunction(functionName As String, ParamArray args()) As Variant
    Dim cmdValidate As ADODB.Command
    Dim cmdExecute As ADODB.Command
    Dim cmdRenew As ADODB.Command
    Dim rs As ADODB.Recordset
    Dim functionArgs() As Variant
    Dim i As Long
    Dim commandText As String
    
    ' Store args in a separate array to ensure they're not lost
    ReDim functionArgs(LBound(args) To UBound(args))
    For i = LBound(args) To UBound(args)
        functionArgs(i) = args(i)
    Next i
    
    ' Debug print arguments
    For i = LBound(functionArgs) To UBound(functionArgs)
        Debug.Print "Argument " & i & ": Type=" & TypeName(functionArgs(i)) & ", Value=" & Left$(CStr(functionArgs(i)), 100)
    Next i
    
    ' Validate session and permission
    Set cmdValidate = New ADODB.Command
    With cmdValidate
        .ActiveConnection = g_conn
        .CommandText = "SELECT (validate_session_and_permission(?, ?)).*"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_function_name", adVarChar, adParamInput, 255, functionName)
    End With
    
    Set rs = cmdValidate.Execute
    
    Dim isValid As Boolean
    If Not rs.EOF Then
        isValid = rs.Fields("is_valid").Value
    Else
        isValid = False
    End If
    
    rs.Close
    Set rs = Nothing
    Set cmdValidate = Nothing
    
    If Not isValid Then
        MsgBox "You don't have permission to perform this action.", vbExclamation
        ExecuteProtectedFunction = False
        Exit Function
    End If
    
    ' Execute the actual function or procedure
    Set cmdExecute = New ADODB.Command
    With cmdExecute
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        commandText = "CALL " & functionName & "("
        
        ' Add parameters
        For i = LBound(functionArgs) To UBound(functionArgs)
            If i > LBound(functionArgs) Then commandText = commandText & ", "
            If i = LBound(functionArgs) And functionName = "insert_mrl_line_items" Then
                commandText = commandText & "?::jsonb"
            ElseIf i = LBound(functionArgs) + 1 And functionName = "insert_mrl_line_items" Then
                commandText = commandText & "?::text"
            Else
                commandText = commandText & "?"
            End If
            .Parameters.Append .CreateParameter("param" & (i + 1), adLongVarChar, adParamInput, -1, functionArgs(i))
        Next i
        
        commandText = commandText & ")"
        .CommandText = commandText
        
        ' Debug print
        Debug.Print "Command text: " & commandText
        Debug.Print "Command text length: " & Len(commandText)
    End With
    
    On Error GoTo ErrorHandler
    
    Dim result As ADODB.Recordset
    Set result = cmdExecute.Execute
    
    ' Check for NOTICE messages
    Dim noticeMessage As String
    noticeMessage = GetNoticeMessage(g_conn)
    
    If Len(noticeMessage) > 0 Then
        Debug.Print "NOTICE: " & noticeMessage
        ' Here you can parse the notice message to get detailed results
        ExecuteProtectedFunction = ParseNoticeMessage(noticeMessage)
    Else
        ExecuteProtectedFunction = True ' Indicate success
    End If
    
    ' Renew session
    Set cmdRenew = New ADODB.Command
    With cmdRenew
        .ActiveConnection = g_conn
        .CommandType = adCmdText
        .CommandText = "SELECT renew_session(?, ?)"
        .Parameters.Append .CreateParameter("@p_session_id", adGUID, adParamInput, , g_sessionToken)
        .Parameters.Append .CreateParameter("@p_duration", adVarChar, adParamInput, 255, "1 hour")
    End With
    
    Set rs = cmdRenew.Execute
    
    If Not rs.EOF Then
        Dim renewSuccess As Boolean
        renewSuccess = rs.Fields(0).Value
        If Not renewSuccess Then
            Debug.Print "Failed to renew session"
        End If
    End If
    
    Exit Function

ErrorHandler:
    Debug.Print "Error in ExecuteProtectedFunction: " & Err.Description
    Debug.Print "Error Number: " & Err.Number
    Debug.Print "Command Text: " & commandText
    Debug.Print "Command Text length: " & Len(commandText)
    
    ' Print out all parameter values for debugging
    For i = LBound(functionArgs) To UBound(functionArgs)
        Debug.Print "Parameter " & i + 1 & ": Type=" & TypeName(functionArgs(i)) & ", Value=" & Left$(CStr(functionArgs(i)), 100) & "..."
    Next i
    
    ExecuteProtectedFunction = False ' Indicate failure
    If Err.Number = 42883 Then  ' Function does not exist
        MsgBox "Function or procedure '" & functionName & "' does not exist.", vbExclamation
    Else
        MsgBox "An error occurred: " & Err.Description & vbNewLine & _
               "See Immediate window for more details.", vbExclamation
    End If

CleanUp:
    ' Clean up
    If Not rs Is Nothing Then
        rs.Close
        Set rs = Nothing
    End If
    Set cmdExecute = Nothing
    Set cmdRenew = Nothing
End Function

' Helper function to get NOTICE messages
Private Function GetNoticeMessage(conn As ADODB.Connection) As String
    Dim cmd As ADODB.Command
    Dim rs As ADODB.Recordset
    
    Set cmd = New ADODB.Command
    With cmd
        .ActiveConnection = conn
        .CommandText = "SELECT pg_get_last_result_notices() AS notice"
    End With
    
    Set rs = cmd.Execute
    
    If Not rs.EOF Then
        GetNoticeMessage = rs.Fields("notice").Value
    Else
        GetNoticeMessage = ""
    End If
    
    rs.Close
    Set rs = Nothing
    Set cmd = Nothing
End Function

' Helper function to parse NOTICE message
Private Function ParseNoticeMessage(message As String) As Variant
    Dim result(3) As Long
    Dim matches As Object
    Dim regex As Object
    
    Set regex = CreateObject("VBScript.RegExp")
    regex.Pattern = "Total: (\d+), Success: (\d+), Duplicates: (\d+), Errors: (\d+)"
    regex.Global = False
    
    Set matches = regex.Execute(message)
    
    If matches.Count > 0 Then
        result(0) = CLng(matches(0).SubMatches(0)) ' Total
        result(1) = CLng(matches(0).SubMatches(1)) ' Success
        result(2) = CLng(matches(0).SubMatches(2)) ' Duplicates
        result(3) = CLng(matches(0).SubMatches(3)) ' Errors
    End If
    
    ParseNoticeMessage = result
End Function