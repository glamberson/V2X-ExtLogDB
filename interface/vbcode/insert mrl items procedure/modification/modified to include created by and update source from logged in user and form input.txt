' Fetch the current user logged into the Access database
Function GetCurrentUser() As Integer
    ' Example function to return the logged-in user ID
    ' This should be replaced with actual logic to get the logged-in user ID
    GetCurrentUser = 1 ' Placeholder, replace with actual user ID fetching logic
End Function

' Function to get the update source from the form
Function GetUpdateSource() As String
    GetUpdateSource = Forms("YourFormName")!UpdateSourceTextBox ' Replace with your form and control names
End Function

' Validate the Excel data before importing
Public Function ValidateExcelData() As Boolean
    Dim ws As Worksheet
    Dim row As Integer
    Dim isValid As Boolean
    
    Set ws = ThisWorkbook.Sheets("Sheet1") ' Adjust to your sheet name
    isValid = True
    
    For row = 2 To ws.Cells(ws.Rows.Count, "A").End(xlUp).row ' Assuming row 1 is the header row
        If IsEmpty(ws.Cells(row, 1)) Then ' Validate jcn
            MsgBox "Error: jcn is required at row " & row
            isValid = False
        End If
        
        If Not IsNumeric(ws.Cells(row, 8)) Or ws.Cells(row, 8).Value <= 0 Then ' Validate qty
            MsgBox "Error: qty must be a positive number at row " & row
            isValid = False
        End If
        
        If Not IsDate(ws.Cells(row, 13)) Then ' Validate request_date
            MsgBox "Error: request_date must be a valid date at row " & row
            isValid = False
        End If
        
        ' Additional validation rules can be added here...
        
        If Not isValid Then Exit For
    Next row
    
    ValidateExcelData = isValid
End Function

' Import the Excel data into a temporary table
Sub ImportExcelToAccess()
    Dim filePath As String
    filePath = "C:\path\to\your\excel_file.xlsx"
    
    DoCmd.TransferSpreadsheet acImport, acSpreadsheetTypeExcel12, "TempTable", filePath, True
End Sub

' Convert the imported data to JSON format
Public Function ConvertToJSON() As String
    Dim db As DAO.Database
    Dim rs As DAO.Recordset
    Dim json As String
    Dim f As DAO.Field
    
    Set db = CurrentDb()
    Set rs = db.OpenRecordset("SELECT * FROM TempTable")

    json = "["
    
    Do While Not rs.EOF
        json = json & "{"
        For Each f In rs.Fields
            json = json & """" & f.Name & """:"
            If IsNull(f.Value) Then
                json = json & "null"
            ElseIf f.Type = dbText Then
                json = json & """" & f.Value & """"
            Else
                json = json & f.Value
            End If
            json = json & ","
        Next f
        ' Add created_by and update_source fields
        json = json & """created_by"":" & GetCurrentUser() & ","
        json = json & """update_source"":""" & GetUpdateSource() & """"
        json = Left(json, Len(json) - 1)
        json = json & "},"
        rs.MoveNext
    Loop
    
    json = Left(json, Len(json) - 1)
    json = json & "]"
    
    rs.Close
    Set rs = Nothing
    Set db = Nothing
    
    ConvertToJSON = json
End Function

' Call the stored procedure to insert MRL line items
Public Sub InsertMRLLineItems()
    Dim conn As ADODB.Connection
    Dim cmd As ADODB.Command
    Dim jsonData As String
    
    jsonData = ConvertToJSON()
    
    Set conn = GetPostgreSQLConnection()
    Set cmd = New ADODB.Command
    
    With cmd
        .ActiveConnection = conn
        .CommandType = adCmdText
        .CommandText = "CALL insert_mrl_line_items(?)"
        .Parameters.Append .CreateParameter("@batch_data", adLongVarChar, adParamInput, , jsonData)
        .Execute
    End With
    
    conn.Close
End Sub

' Establish a connection to the PostgreSQL database
Public Function GetPostgreSQLConnection() As ADODB.Connection
    Dim conn As ADODB.Connection
    Set conn = New ADODB.Connection
    conn.ConnectionString = "Driver={PostgreSQL Unicode};Server=your_server;Port=5432;Database=your_db;Uid=your_username;Pwd=your_password;"
    conn.Open
    Set GetPostgreSQLConnection = conn
End Function

' Main procedure to import and insert MRL line items
Sub ImportAndInsertMRLLineItems()
    If Not ValidateExcelData() Then
        MsgBox "Data validation failed. Please correct the errors and try again."
        Exit Sub
    End If
    
    ImportExcelToAccess
    InsertMRLLineItems
End Sub
