Public Sub InsertMRLLineItems()
    Dim conn As ADODB.Connection
    Dim cmd As ADODB.Command
    Dim jsonData As String
    Dim updateSource As String

    ' Fetch the JSON data
    jsonData = ConvertToJSON()

    ' Get the update source from the form
    updateSource = Forms("YourFormName").Controls("txtUpdateSource").Value

    ' Debugging output
    Debug.Print "Generated JSON Data: " & jsonData ' Print JSON to Immediate Window for debugging
    Debug.Print "Update Source: " & updateSource ' Print update source for debugging

    ' Validate JSON
    If jsonData = "[]" Then
        MsgBox "No valid records found to insert.", vbInformation
        Exit Sub
    End If

    ' Establish the database connection
    Set conn = GetPostgreSQLConnection()
    Set cmd = New ADODB.Command

    ' Prepare the stored procedure call
    With cmd
        .ActiveConnection = conn
        .CommandType = adCmdText
        .CommandText = "CALL insert_mrl_line_items(?, ?)"
        .Parameters.Append .CreateParameter("@batch_data", adLongVarChar, adParamInput, Len(jsonData), jsonData)
        .Parameters.Append .CreateParameter("@update_source", adVarChar, adParamInput, Len(updateSource), updateSource)
        .Execute
    End With

    ' Close the connection
    conn.Close
    Set conn = Nothing

    MsgBox "MRL line items successfully inserted.", vbInformation
    Exit Sub

ErrorHandler:
    MsgBox "Error in InsertMRLLineItems: " & Err.Description & " (Error " & Err.Number & ")", vbCritical
    If Not conn Is Nothing Then
        If conn.State = adStateOpen Then conn.Close
    End If
End Sub
