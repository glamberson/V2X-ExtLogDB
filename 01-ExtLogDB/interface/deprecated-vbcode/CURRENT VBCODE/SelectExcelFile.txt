
' Select Excel File (Windows API)
' version 0.9.10

Public Function SelectExcelFile() As String
    On Error GoTo ErrorHandler
    
    Debug.Print "Starting SelectExcelFile function"
    
    Dim OpenFile As OPENFILENAME
    Dim lReturn As Long
    Dim sFilter As String
    
    'Set the structure size
    OpenFile.lStructSize = LenB(OpenFile)
    
    'Set the filter
    sFilter = "Excel Files (*.xlsx; *.xls)" & Chr(0) & "*.xlsx;*.xls" & Chr(0) & "All Files (*.*)" & Chr(0) & "*.*" & Chr(0)
    OpenFile.lpstrFilter = sFilter
    
    'Set the maximum number of characters
    OpenFile.nMaxFile = 260
    
    'Create a string buffer
    OpenFile.lpstrFile = String(OpenFile.nMaxFile, 0)
    
    'Set the initial directory (optional, you can comment this out if not needed)
    OpenFile.lpstrInitialDir = CurDir
    
    'Set the dialog box title
    OpenFile.lpstrTitle = "Select Excel File"
    
    'No flags
    OpenFile.Flags = 0
    
    Debug.Print "About to call GetOpenFileName"
    'Show the 'Open File' dialog box
    lReturn = GetOpenFileName(OpenFile)
    
    Debug.Print "GetOpenFileName returned: " & lReturn
    
    If lReturn <> 0 Then
        SelectExcelFile = Left(OpenFile.lpstrFile, InStr(OpenFile.lpstrFile, vbNullChar) - 1)
        Debug.Print "Selected file: " & SelectExcelFile
    Else
        SelectExcelFile = ""
        Debug.Print "No file selected"
    End If
    
    Exit Function

ErrorHandler:
    Debug.Print "Error in SelectExcelFile: " & Err.Description
    SelectExcelFile = ""
End Function

