-- Table for storing fulfillment items
CREATE TABLE fulfillment_items (
    fulfillment_item_id SERIAL PRIMARY KEY, -- Unique identifier for the fulfillment record
    order_line_item_id INT NOT NULL REFERENCES MRL_line_items(order_line_item_id) ON DELETE CASCADE, -- Foreign key to MRL line items
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp when the fulfillment record was created
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp when the fulfillment record was last updated
    milstrip_req_no VARCHAR(50), -- Requisition or MILSTRIP number
    edd_to_ches DATE, -- Estimated delivery date to Chesapeake
    rcd_v2x_date DATE, -- Received at V2X date
    lot_id VARCHAR(15), -- Lot identifier
    triwall VARCHAR(15), -- Tri-wall identifier
    shipdoc_tcn VARCHAR(30), -- Shipping document TCN
    v2x_ship_no VARCHAR(20), -- V2X shipment number
    booking VARCHAR(20), -- Booking number
    vessel VARCHAR(30), -- Vessel name
    container VARCHAR(25), -- Container number
    sail_date DATE, -- Sail date
    edd_to_egypt DATE, -- Estimated delivery date to Egypt
    arr_lsc_egypt DATE, -- Arrival at LSC Egypt
    lsc_on_hand_date DATE, -- LSC on-hand date
    carrier VARCHAR(50), -- Carrier information for the shipment
    status_id INT REFERENCES statuses(status_id), -- Foreign key to statuses table
    created_by INT REFERENCES roles(role_id), -- User who created the fulfillment record
    updated_by VARCHAR(50), -- User who last updated the fulfillment record
    update_source VARCHAR(50), -- Source of the most recent update
    has_comments BOOLEAN DEFAULT FALSE, -- Indicates if any user comments have been added for the fulfillment record
    inquiry_status BOOLEAN DEFAULT FALSE, -- Flag set when review of the fulfillment record is requested
    UNIQUE (order_line_item_id, fulfillment_item_id) -- Ensures unique combination of order line item and fulfillment record
);

-- Table for storing audit trail information
CREATE TABLE audit_trail (
    audit_id SERIAL PRIMARY KEY, -- Unique identifier for the audit record
    order_line_item_id INT REFERENCES MRL_line_items(order_line_item_id) ON DELETE CASCADE, -- Foreign key to MRL line items
    fulfillment_item_id INT REFERENCES fulfillment_items(fulfillment_item_id) ON DELETE CASCADE, -- Foreign key to fulfillment items
    action VARCHAR(100), -- Description of the action taken
    changed_by VARCHAR(50), -- User who made the change
    changed_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp when the change was made
    details TEXT, -- Detailed description of the change
    update_source VARCHAR(50), -- Source of the update
    role_id INT REFERENCES roles(role_id), -- Foreign key to roles table
    user_id INT REFERENCES users(user_id) -- Foreign key to users table
);

-- Table for storing line item comments
CREATE TABLE line_item_comments (
    comment_id SERIAL PRIMARY KEY, -- Unique identifier for the comment
    order_line_item_id INT, -- Foreign key to MRL line items or fulfillment items
    fulfillment_item_id INT, -- Foreign key to fulfillment items or NULL if it refers to MRL line item
    comment TEXT, -- The comment text
    commented_by VARCHAR(100), -- User who made the comment
    commented_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp with timezone when the comment was made
    role_id INT REFERENCES roles(role_id), -- Foreign key to roles table
    CHECK ((order_line_item_id IS NOT NULL AND fulfillment_item_id IS NULL) OR 
           (order_line_item_id IS NULL AND fulfillment_item_id IS NOT NULL)) -- Ensure only one of the two fields is set
);

-- Table for storing line item inquiries
CREATE TABLE line_item_inquiry (
    inquiry_id SERIAL PRIMARY KEY, -- Unique identifier for the inquiry record
    order_line_item_id INT REFERENCES MRL_line_items(order_line_item_id) ON DELETE CASCADE, -- Foreign key to MRL line items
    inquiry_status BOOLEAN, -- Status of the inquiry (e.g., TRUE for active inquiry, FALSE for resolved)
    updated_by VARCHAR(50), -- User who updated the inquiry status
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp when the inquiry status was updated
    role_id INT REFERENCES roles(role_id) -- Foreign key to roles table
);

-- Table for storing user activity
CREATE TABLE user_activity (
    activity_id SERIAL PRIMARY KEY, -- Unique identifier for the activity record
    user_id INT REFERENCES users(user_id) ON DELETE CASCADE, -- Foreign key to users table
    activity_type VARCHAR(50) NOT NULL, -- Type of activity (e.g., 'login', 'logout', 'failed_login')
    activity_time TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP, -- Timestamp when the activity occurred
    activity_details TEXT -- Additional details about the activity
);



-- Table for temporary bulk update data
CREATE TABLE temp_bulk_update (
    fulfillment_item_id SERIAL PRIMARY KEY,
    order_line_item_id INT,
    edd_to_ches DATE,
    rcd_v2x_date DATE,
    lot_id VARCHAR(15),
    triwall VARCHAR(15),
    shipdoc_tcn VARCHAR(30),
    v2x_ship_no VARCHAR(20),
    booking VARCHAR(20),
    vessel VARCHAR(30),
    container VARCHAR(25),
    sail_date DATE,
    edd_to_egypt DATE,
    arr_lsc_egypt DATE,
    lsc_on_hand_date DATE,
    carrier VARCHAR(50),
    status_id INT REFERENCES statuses(status_id),
    flag_for_review BOOLEAN DEFAULT FALSE,
    reason TEXT
);

